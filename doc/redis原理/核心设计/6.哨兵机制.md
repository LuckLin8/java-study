## 哨兵模式

在主从架构下，如果从库发生故障，客户端可以继续像主库或者从库发送请求，进行相关操作。
如果主库发生故障，会直接影响到从库的同步，并且客户端进行的写操作都会出现异常

无论写服务终端还是从库无法进行数据同步，都无法接受，所以如果主库挂了，我们需要一个新的主库，或者把从库切换为主库，这就涉及三个问题：
1. 主库是否真的挂掉？
2. 该选择哪个库作为主库？
3. 怎么把新的主库信息通知给从库以及客户端？

这就要提到哨兵机制了。在 Redis 主从集群中，哨兵机制是实现主从库自动切换的关键机制，它有效地解决了主从复制模式下故障转移的这三个问题

### 哨兵机制的基本流程
哨兵其实就是一个运行在特殊模式下的 Redis 进程，主从库实例运行的同时，它也在运行。哨兵主要负责的就是三个任务：
- 监控
- 选主（选择主库）
- 通知

1. 监控

    监控是指哨兵运行过程中，周期性给所有主从库发送PING命令，检测他们是否依然在线运行，
    如果从库在规定时间内没有响应哨兵的PING命令，哨兵会将该库标记为`下线状态`，如果主库没有响应，哨兵会判定为主库下线，然后开始自动切换主库的流程
    
2. 选主
    
    主库挂了后，哨兵在从库中根据一定的规则选出一个从库实例，把它作为新的主库
    
3. 通知
    
    选定完主库后，哨兵会把新的主库的连接信息发送给其它从库，让他们执行replicaof命令，和新的主库建立连接并进行数据的复制，同时将新主库信息通知给客户端
    
### 在监控任务中，哨兵怎么判断主库是否处于下线状态？

哨兵对于主库的下线判断有`主管下线`和`客观下线`两种

主观下线：哨兵进程会使用 PING 命令检测它自己和主、从库的网络连接情况，用来判断实例的状态。如果哨兵发现主库或从库对 PING 命令的响应超时了，那么，哨兵就会先把它标记为“主观下线”
        
如果检测的是从库，那么，哨兵简单地把它标记为“主观下线”就行了，因为从库的下线影响一般不太大，集群的对外服务不会间断
    
如果检测的是主库，那么，哨兵还不能简单地把它标记为“主观下线”，开启主从切换。因为很有可能存在这么一个情况：那就是哨兵误判了，其实主库并没有故障。可是，一旦启动了主从切换，后续的选主和通知操作都会带来额外的计算和通信开销
    
什么叫误判？什么情况下会出现误判？

    误判就是主库实际并没有下线，但是哨兵误以为它下线了。误判一般会发生在集群网络压力较大、网络拥塞，或者是主库本身压力较大的情况下
    
如何减少误判？

    通常会采用多实例组成的集群模式进行部署，这也被称为哨兵集群。引入多个哨兵实例一起来判断，就可以避免单个哨兵因为自身网络状况不好，
    而误判主库下线的情况。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低
    
客观下线：判断主库是否下线时，不能由一个哨兵说了算，只有大多数的哨兵实例，都判断主库已经“主观下线”了，主库才会被标记为“客观下线”，这个叫法也是表明主库下线成为一
        个客观事实了。这个判断原则就是：少数服从多数。同时，这会进一步触发哨兵开始主从切换流程

### 在选主任务中，哨兵如何决定选择哪个从库实例作为主库？

一般来说，哨兵选择新主库的过程称为“筛选 + 打分”。简单来说，在多个从库中，先按照一定的筛选条件，把不符合条件的从库去掉。然后，我们再按照一定的规则，给剩下的从库逐个打分，将得分最高的从库选为新主库

![哨兵选主](https://blog-images12.oss-cn-beijing.aliyuncs.com/%E5%93%A8%E5%85%B5%E9%80%89%E4%B8%BB.jpg)

什么是筛选条件？除了要检查从库的当前在线状态，还要判断它之前的网络连接状态

如果从库总是和主库断连，而且断连次数超出了一定的阈值，我们就有理由相信，这个从库的网络状况并不是太好，就可以把这个从库筛掉了

    具体怎么判断呢？你使用配置项 down-after-milliseconds * 10。其中，down-aftermilliseconds 是我们认定主从库断连的最大连接超时时间。
    如果在 down-aftermilliseconds 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不好，不适合作为新主库
    
根据什么进行打分？ 从库优先级、从库复制进度以及从库 ID 号

按照三个规则依次进行三轮打分，这三个规则分别是从库优先级、从库复制进度以及从库 ID 号。
只要在某一轮中，有从库得分最高，那么它就是主库了，选主过程到此结束。如果没有出现得分最高的从库，那么就继续进行下一轮

- 第一轮，优先级最高的从库得分高
    
    用户可以通过 slave-priority 配置项，给不同的从库设置不同优先级。比如，有两个从库，它们的内存大小不一样，你可以手动给内存大的实例设置一个高优先级。在选主时，
    哨兵会给优先级高的从库打高分，如果有一个从库优先级最高，那么它就是新主库了。如果从库的优先级都一样，那么哨兵开始第二轮打分。

- 第二轮，和旧主库同步程度最接近的从库得分高

    如果选择和旧主库同步最接近的那个从库作为主库，那么，这个新主库上就有最新的数据
    
    主从库同步时有个命令传播的过程。在这个过程中，主库会用master_repl_offset 记录当前的最新写操作在 repl_backlog_buffer 中的位置，而从库会
    用 slave_repl_offset 这个值记录当前的复制进度此时，我们想要找的从库，它的 slave_repl_offset 需要最接近 master_repl_offset。如果
    在所有从库中，有从库的 slave_repl_offset 最接近 master_repl_offset，那么它的得分就最高，可以作为新主库
    
- 第三轮，ID 号小的从库得分高

    每个实例都会有一个 ID，这个 ID 就类似于这里的从库的编号，在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库